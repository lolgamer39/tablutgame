<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partita - Tablut</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="game.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>

    <div class="bg-overlay"></div>

    <audio id="move-sound">
        <source src="../move.mp3" type="audio/mp3">
    </audio>
    <audio id="win-sound">
        <source src="../win.mp3" type="audio/mp3">
    </audio>

    <div id="status-badge" class="status-badge-floating">
        Tocca ai <strong id="current-player">Neri</strong>
    </div>

    <div id="connection-warning" class="hidden toast toast-warning">‚ö†Ô∏è Connessione instabile...</div>
    <div id="opponent-warning" class="hidden toast toast-info">‚è≥ L'avversario ha perso la connessione...</div>

    <div class="app-container">
        
        <div class="game-section">
            <div class="board-wrapper-tight">
                <div id="online-ui" class="hidden compact-bar">
                    <div class="player-info-group">
                        <div id="opp-color" class="color-dot"></div> 
                        <div class="player-name" id="opp-name">Avversario</div>
                    </div>
                    <div class="stats-group">
                        <span class="timer-badge" id="opp-timer">--:--</span>
                        <div class="signal-bars signal-4" id="opp-signal"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                    </div>
                </div>

                <div id="board"></div>

                <div id="online-ui-bottom" class="hidden compact-bar">
                    <div class="player-info-group">
                        <div id="my-color" class="color-dot"></div> 
                        <div class="player-name" id="my-name">Tu</div>
                    </div>
                    <div class="stats-group">
                        <span class="timer-badge" id="my-timer">--:--</span>
                        <div class="signal-bars signal-4" id="my-signal"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                    </div>
                </div>

                <div id="mobile-actions" class="mobile-only-actions">
                    <button id="undo-btn-mobile" class="btn btn-secondary btn-sm" onclick="requestUndo()">Annulla Mossa</button>
                    <button id="settings-btn-mobile" class="btn btn-outline btn-icon btn-sm" onclick="toggleSettingsModal()">‚öôÔ∏è</button>
                    <button id="surrender-btn-mobile" class="btn btn-danger btn-sm" onclick="handleSurrender()">Abbandona</button>
                    <button id="restart-btn-mobile" class="btn btn-primary btn-sm hidden" onclick="restartLocalGame()">Riavvia Partita</button>
                </div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-header">
                <h3>Storico Mosse</h3>
                <button class="btn btn-outline btn-icon btn-sm desktop-only" onclick="toggleSettingsModal()">‚öôÔ∏è</button>
            </div>
            
            <div class="history-scroll-area" id="move-history-container">
                <table class="move-table" id="move-table">
                    <thead><tr><th>#</th><th>Neri</th><th>Bianchi</th></tr></thead>
                    <tbody id="move-list-body"></tbody>
                </table>
            </div>

            <div class="history-controls">
                <button id="btn-prev" class="btn btn-outline btn-icon">‚óÄ</button>
                <button id="btn-next" class="btn btn-outline btn-icon">‚ñ∂</button>
            </div>

            <div class="desktop-actions">
                <button id="undo-btn" class="btn btn-secondary" onclick="requestUndo()">Annulla Mossa</button>
                <button id="surrender-btn" class="btn btn-danger" onclick="handleSurrender()">Abbandona Partita</button>
                <button id="restart-btn" class="btn btn-primary hidden" onclick="restartLocalGame()">Riavvia Partita</button>
            </div>
        </div>

    </div>

    <div id="game-result-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h2 id="result-title">Vittoria!</h2>
            <p id="result-msg" class="modal-desc"></p>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="exitGameAndClear()">Home</button>
                <button class="btn btn-primary" id="play-again-btn">Gioca di nuovo</button>
            </div>
        </div>
    </div>

    <div id="undo-request-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>Richiesta Ritiro</h3>
            <p>L'avversario vuole annullare l'ultima mossa.</p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="respondUndo(true)">Accetta</button>
                <button class="btn btn-danger" onclick="respondUndo(false)">Rifiuta</button>
            </div>
        </div>
    </div>

    <div id="confirm-surrender-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3 id="confirm-surrender-title">Abbandona</h3>
            <p id="confirm-surrender-desc">Sei sicuro di voler abbandonare?</p>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="executeSurrender()">S√¨, abbandona</button>
                <button class="btn btn-outline" onclick="closeConfirmModals()">Annulla</button>
            </div>
        </div>
    </div>

    <div id="confirm-undo-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>Annulla Mossa</h3>
            <p id="confirm-undo-desc">Vuoi annullare l'ultima mossa?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="executeUndo()">S√¨, annulla</button>
                <button class="btn btn-outline" onclick="closeConfirmModals()">Indietro</button>
            </div>
        </div>
    </div>

    <div id="confirm-restart-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>Riavvia Partita</h3>
            <p>Sei sicuro di voler riavviare la partita da capo?</p>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="executeRestart()">S√¨, riavvia</button>
                <button class="btn btn-outline" onclick="closeConfirmModals()">Annulla</button>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>Impostazioni</h3>
            
            <div class="setting-item">
                <span>Mostra suggerimenti</span>
                <label class="switch">
                    <input type="checkbox" id="hints-toggle" checked onchange="toggleHints()">
                    <span class="slider round"></span>
                </label>
            </div>

            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
            
            <div class="setting-item">
                <span>üîä Effetti</span>
                <div style="display:flex; flex-direction:column; align-items:end; gap:5px; width: 50%;">
                    <label class="switch">
                        <input type="checkbox" id="sfx-toggle" checked onchange="updateAudioSettings()">
                        <span class="slider round"></span>
                    </label>
                    <input type="range" id="sfx-vol" min="0" max="1" step="0.1" style="width:100%" oninput="updateAudioSettings()">
                </div>
            </div>

            <div class="setting-group-title" style="margin-top: 20px; margin-bottom: 8px;">Tema Scacchiera</div>
            
            <select id="theme-selector" onchange="applyTheme(this.value)">
                <option value="classic">üõ°Ô∏è Classico (Legno e Oro)</option>
                <option value="ice">‚ùÑÔ∏è Regno di Ghiaccio</option>
                <option value="magma">üî• Magma Vulcano</option>
                <option value="forest">üå≤ Foresta Notturna</option>
                <option value="cyber">ü§ñ Cyberpunk Neon</option>
            </select>
            
            <br><br>
            <button class="btn btn-outline" onclick="toggleSettingsModal()">Chiudi</button>
            <br><br>
            <button class="btn btn-danger btn-sm" onclick="exitGameAndClear()">Torna al Menu (Esci)</button>
        </div>
    </div>

    <script src="game.js"></script>
</body>
</html>
